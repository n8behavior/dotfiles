#!/usr/bin/env bash

set -e

# Recovery drive path for secrets
RECOVERY_PATH="/media/sandman/Recovery/secrets"

install-common-packages() {
  echo 'INSTALLING: common-packages'
  sudo apt install -y xclip build-essential gnupg curl tmux tree git{,-lfs,-extras} etckeeper software-properties-common fuse2fs pcscd libpcsclite-dev pkgconf
  sudo apt remove -y nano
  git lfs install
}

install-passage() {
  echo 'INSTALLING: passage + age tools'
  type -p rustup || setup-rust
  . "$HOME/.cargo/env"

  # Install rage (Rust age implementation) and YubiKey plugin
  cargo install rage age-plugin-yubikey

  # Create symlinks for age compatibility
  sudo ln -sf "$HOME/.cargo/bin/rage" /usr/local/bin/age
  sudo ln -sf "$HOME/.cargo/bin/rage-keygen" /usr/local/bin/age-keygen

  # Install passage
  if [[ ! -f /usr/local/bin/passage ]]; then
    git clone https://github.com/FiloSottile/passage.git /tmp/passage
    sudo cp /tmp/passage/src/password-store.sh /usr/local/bin/passage
    sudo chmod +x /usr/local/bin/passage
    rm -rf /tmp/passage
  fi
}

restore-secrets() {
  echo 'RESTORING: secrets from Recovery drive'

  if [[ ! -d "$RECOVERY_PATH/passage-store" ]]; then
    echo "ERROR: Recovery drive not found at $RECOVERY_PATH"
    echo "Please mount the Recovery drive and try again."
    exit 1
  fi

  # Restore passage store
  mkdir -p ~/.passage/store
  cp -r "$RECOVERY_PATH/passage-store/." ~/.passage/store/
  chmod 700 ~/.passage/store

  # Setup YubiKey identity for passage
  echo "Please insert your YubiKey..."
  age-plugin-yubikey --identity > ~/.passage/identities

  # Restore SSH keys
  echo "Restoring SSH keys (touch YubiKey when prompted)..."
  mkdir -p ~/.ssh && chmod 700 ~/.ssh
  passage show ssh/id_ed25519 > ~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519
  passage show ssh/id_ed25519.pub > ~/.ssh/id_ed25519.pub && chmod 644 ~/.ssh/id_ed25519.pub
  passage show ssh/id_rsa > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
  passage show ssh/id_rsa.pub > ~/.ssh/id_rsa.pub && chmod 644 ~/.ssh/id_rsa.pub
  passage show ssh/known_hosts > ~/.ssh/known_hosts

  # Restore GPG keys
  echo "Restoring GPG keys..."
  passage show gpg/secret-keys | gpg --import
  passage show gpg/public-keys | gpg --import
  passage show gpg/ownertrust | gpg --import-ownertrust

  # Restore SOPS key
  echo "Restoring SOPS key..."
  mkdir -p ~/.config/sops/age
  passage show sops/age-key > ~/.config/sops/age/keys.txt
  chmod 600 ~/.config/sops/age/keys.txt

  # Restore keyrings
  echo "Restoring keyrings..."
  mkdir -p ~/.local/share/keyrings
  passage show keyrings/login.keyring > ~/.local/share/keyrings/login.keyring
  passage show keyrings/user.keystore > ~/.local/share/keyrings/user.keystore

  # Restore atuin key
  echo "Restoring atuin key..."
  mkdir -p ~/.local/share/atuin
  passage show atuin/key > ~/.local/share/atuin/key
  chmod 600 ~/.local/share/atuin/key

  # Restore gh token (for headless environments without keyring)
  echo "Restoring GitHub CLI token..."
  passage show gh/token | gh auth login --with-token

  # Restore Claude Code credentials
  echo "Restoring Claude Code credentials..."
  mkdir -p ~/.claude
  passage show claude/credentials > ~/.claude/.credentials.json
  chmod 600 ~/.claude/.credentials.json

  echo "Secrets restored successfully!"
}

install-github-cli() {
  echo 'INSTALLING: GitHub CLI'
  type -p curl || install-common-packages
  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
  sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list
  sudo apt install gh -y
}

install-nvm() {
  local version=$(gh release --repo nvm-sh/nvm view | head -n1 | awk '{print $2}')
  echo "INSTALLING: Node Version Manager (${version}"
  type -p curl || install-common-packages
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/${version}/install.sh | bash
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
  nvm install --lts
  nvm install-latest-npm
  # Only append NVM config if it doesn't already exist in .bashrc
  if ! grep -q 'NVM_DIR="$HOME/.nvm"' "$HOME/.bashrc"; then
    echo "Adding NVM configuration to .bashrc"
    cat <<'END' >>"$HOME/.bashrc"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
END
  else
    echo "NVM configuration already exists in .bashrc"
  fi
}

setup-editor() {
  echo 'INSTALLING: Neovim'
  type -p gh || install-github-cli
  gh release download --repo neovim/neovim --pattern nvim-linux-x86_64.appimage
  mv nvim-linux-x86_64.appimage ~/.local/bin/nvim.appimage
  chmod +x ~/.local/bin/nvim.appimage
  sudo update-alternatives --install /usr/bin/editor editor ~/.local/bin/nvim.appimage 100
  sudo update-alternatives --auto editor
}

install-lazyvim() {
  echo 'INSTALLING: LazyVim'
  type -p nvm || install-nvm
  type -p gh || install-github-cli
  local nvim_config=$HOME/.config/nvim
  if [ ! -d "$nvim_config" ]; then
    echo "Setting up LazyVim starter config"
    gh repo clone LazyVim/starter $nvim_config
    rm -rf $nvim_config/.git
  else
    echo "Neovim config already exists at $nvim_config, skipping LazyVim setup"
    # Clean up lock file if it exists (for machine-specific regeneration)
    if [ -f "$nvim_config/lazy-lock.json" ]; then
      echo "Removing lazy-lock.json for local regeneration"
      rm -f "$nvim_config/lazy-lock.json"
    fi
  fi
  npm i -g markdownlint-cli2 markdown-toc prettier
}

install-yubikey-manager() {
  echo 'INSTALLING: Yubikey Mangager'
  type -p add-apt-repository || install-common-packages
  sudo add-apt-repository --yes ppa:yubico/stable
  sudo apt install -y yubikey-manager
}

setup-rust() {
  type -p rustup || {
    echo "INSTALLING: Rust dev environment"
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  }
  echo "UPDATING: Rust tooling"
  . "$HOME/.cargo/env"
  rustup update
  rustup component add rust-analyzer
}

install-claude-code() {
  echo 'INSTALLING: Claude Code CLI'
  type -p claude && {
    echo "Claude Code is already installed at $(which claude)"
    return 0
  }
  type -p curl || install-common-packages
  curl -fsSL claude.ai/install.sh | bash
  # Verify installation
  if type -p claude > /dev/null; then
    echo "Claude Code $(claude --version) installed successfully"
  else
    echo "Warning: Claude Code installation may have failed"
  fi
}

setup-terminal() {
  # Set caps lock as ctrl (desktop only)
  type -p dconf && dconf write /org/gnome/desktop/input-sources/xkb-options "['caps:ctrl_modifier']"
  type -p starship || {
    echo "INSTALLING: Starship cross-shell prompt"
    curl -sS https://starship.rs/install.sh | sh -s -- -y
  }
  mkdir -p ~/.local/share/fonts
  gh release download --clobber --repo ryanoasis/nerd-fonts --pattern UbuntuMono.tar.xz --dir ~/.local/share/fonts
  tar -xf ~/.local/share/fonts/UbuntuMono.tar.xz -C ~/.local/share/fonts
  type -p fc-cache && fc-cache

  # Install Tmux Plugin Manager
  if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    echo "INSTALLING: Tmux Plugin Manager"
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    # Auto-install plugins if tmux config exists
    if [ -f "$HOME/.tmux.conf" ]; then
      ~/.tmux/plugins/tpm/bin/install_plugins
    fi
  fi
}

echo 'UPDATING: APT Repository Lists'
sudo apt update
echo 'UPDATING: All Installed Packages'
sudo apt dist-upgrade -y
echo 'INSTALLING: Baseline Packages'
install-common-packages
install-yubikey-manager
setup-rust
install-passage
install-github-cli

# Restore secrets if Recovery drive is mounted
if [[ -d "$RECOVERY_PATH/passage-store" ]]; then
  restore-secrets
else
  echo "SKIPPING: secrets restoration (Recovery drive not mounted)"
fi

setup-dotfiles() {
  echo 'SETTING UP: dotfiles'
  if [[ -d ~/.git ]]; then
    echo "Dotfiles already set up, pulling latest..."
    git -C ~ pull
    return 0
  fi
  git clone https://github.com/n8behavior/dotfiles /tmp/dotfiles
  mv /tmp/dotfiles/.git ~
  git -C ~ restore .
  rm -rf /tmp/dotfiles
}

setup-dotfiles

# Ensure paths are available for rest of script (dotfiles may have updated .bashrc)
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$HOME/.atuin/bin:$PATH"

install-atuin() {
  echo 'INSTALLING: Atuin shell history'
  if [[ -d ~/.atuin ]]; then
    echo "Atuin already installed"
    return 0
  fi
  curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh
}

echo 'INSTALLING: Extra Goodies'
install-atuin
install-nvm
setup-editor
install-lazyvim
setup-terminal
install-claude-code
cargo install aichat
